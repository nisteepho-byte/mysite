<!doctype html>
<script src="./api.js?v=2"></script>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Financials — Statements</title>
<link rel="stylesheet" href="../style.css" />
<style>
  .wrap{max-width:1100px;margin:90px auto 40px;padding:0 20px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 14px}
  .tabs a{padding:8px 12px;border:1px solid rgba(255,255,255,.15);border-radius:10px;color:inherit}
  .tabs a.active{border-color:var(--accent)}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:16px}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th,.table td{padding:8px 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15);font-size:12px}
  .muted{color:var(--muted)}
  .spark{height:28px}
</style>
</head>
<body class="dark">
<header class="site-wrap topbar" style="position:fixed;left:0;right:0;top:0">
  <a class="home" href="../index.html">⌂</a>
  <div class="links">
    <a href="./index.html">Overview</a>
    <a href="./statements.html" style="border-bottom:1px solid currentColor">Statements</a>
    <a href="./ratios.html">Ratios</a>
    <a href="./valuation.html">Valuation</a>
  </div>
</header>

<main class="wrap">
  <h1 id="title">Statements</h1>
  <div class="row" id="pills"></div>

  <div class="tabs">
    <a href="#" data-tab="is" class="active">Income Statement</a>
    <a href="#" data-tab="bs">Balance Sheet</a>
    <a href="#" data-tab="cf">Cash Flow</a>
  </div>

  <div id="view" class="card">Loading…</div>
</main>

<script src="./api.js"></script>
<script>
const tk = (new URLSearchParams(location.search).get('t')||'AAPL').toUpperCase();
const $title = document.getElementById('title');
const $pills = document.getElementById('pills');
const $view  = document.getElementById('view');

function spark(arr){
  if (!arr?.length) return '';
  const max = Math.max(...arr), min = Math.min(...arr);
  const pts = arr.map((v,i)=>{
    const x = i*(100/(arr.length-1));
    const y = 28 - ((v-min)/(max-min||1))*28;
    return `${x},${y}`;
  }).join(' ');
  return `<svg class="spark" viewBox="0 0 100 28"><polyline points="${pts}" fill="none" stroke="currentColor" stroke-width="2"/></svg>`;
}
function tr(label, arr, unit="") {
  const cols = (arr||[]).map(v => `<td>${(v??"—")=== "—" ? "—" : (typeof v==="number" ? (unit==="B"?__FMP.fmtB(v):v.toFixed ? v.toFixed(1):v) : v)}</td>`).join('');
  return `<tr><td class="muted">${label}</td>${cols}</tr>`;
}
function yearsFrom(list){ return (list||[]).map(x=>__FMP.ylab(x?.date || x?.calendarYear)); }

async function load() {
  try{
    const [p, q, is, bs, cf] = await Promise.all([
      __FMP.profile(tk), __FMP.quote(tk), __FMP.income(tk,4), __FMP.balance(tk,4), __FMP.cashflow(tk,4)
    ]);
    $title.textContent = `${tk} — ${p?.companyName || "Unknown"}`;
    const yrs = yearsFrom(is);
    $pills.innerHTML = `
      <span class="pill">Years: <strong>${yrs.join(' • ') || '—'}</strong></span>
      <span class="pill">Price: <strong>${q?.price ?? '—'}</strong></span>
      <span class="pill">MktCap: <strong>${q?.marketCap ? __FMP.fmtB(q.marketCap) : '—'}</strong></span>
      <span class="pill">Sector: <strong>${p?.sector || '—'}</strong></span>
    `;

    // cache for tabs
    window.__DATA = { is, bs, cf, yrs };
    render('is');
  } catch (e) {
    $view.innerHTML = `<p class="muted">Could not load ${tk}. Check your API key or ticker.</p>`;
  }
}

function render(tab){
  document.querySelectorAll('.tabs a').forEach(a=>a.classList.toggle('active', a.dataset.tab===tab));
  const yrs = (window.__DATA?.yrs||[]).map(y=>`<th>${y}</th>`).join('');
  if (tab==='is') {
    const d = window.__DATA.is||[];
    const rev = d.map(x=>x.revenue);
    $view.innerHTML = `
      <h3>Income Statement</h3>
      ${spark(rev)}
      <table class="table">
        <thead><tr><th></th>${yrs}</tr></thead>
        <tbody>
          ${tr('Revenue (B)', d.map(x=>x.revenue),'B')}
          ${tr('COGS (B)', d.map(x=>x.costOfRevenue),'B')}
          ${tr('Operating Income (B)', d.map(x=>x.operatingIncome),'B')}
          ${tr('Net Income (B)', d.map(x=>x.netIncome),'B')}
          ${tr('Net Margin (%)', d.map(x=> x.revenue ? (x.netIncome/x.revenue*100) : null))}
        </tbody>
      </table>`;
  } else if (tab==='bs') {
    const d = window.__DATA.bs||[];
    const assets = d.map(x=>x.totalAssets);
    $view.innerHTML = `
      <h3>Balance Sheet</h3>
      ${spark(assets)}
      <table class="table">
        <thead><tr><th></th>${yrs}</tr></thead>
        <tbody>
          ${tr('Total Assets (B)', d.map(x=>x.totalAssets),'B')}
          ${tr('Total Liabilities (B)', d.map(x=>x.totalLiabilities),'B')}
          ${tr('Total Equity (B)', d.map(x=>x.totalStockholdersEquity),'B')}
          ${tr('Cash & Equivalents (B)', d.map(x=>x.cashAndCashEquivalents),'B')}
          ${tr('Leverage (A/E)', d.map(x=> (x.totalAssets/Math.max(x.totalStockholdersEquity||0.0001,0.0001) )))}
        </tbody>
      </table>`;
  } else {
    const d = window.__DATA.cf||[];
    const cfo = d.map(x=>x.netCashProvidedByOperatingActivities);
    $view.innerHTML = `
      <h3>Cash Flow</h3>
      ${spark(cfo)}
      <table class="table">
        <thead><tr><th></th>${yrs}</tr></thead>
        <tbody>
          ${tr('Cash from Ops (B)', d.map(x=>x.netCashProvidedByOperatingActivities),'B')}
          ${tr('Capex (B)', d.map(x=>x.capitalExpenditure),'B')}
          ${tr('FCF (B)', d.map(x=> (x.netCashProvidedByOperatingActivities + (x.capitalExpenditure||0)) ),'B')}
        </tbody>
      </table>`;
  }
}
document.querySelectorAll('.tabs a').forEach(a=>a.addEventListener('click', e=>{e.preventDefault(); render(a.dataset.tab)}));
load();
</script>
</body>
</html>
