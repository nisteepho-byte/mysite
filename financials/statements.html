<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Statements</title>
  <link rel="stylesheet" href="../style.css"/>
  <style>
    .wrap{max-width:1100px;margin:90px auto 40px;padding:0 20px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
    .tabs a{padding:8px 12px;border:1px solid rgba(255,255,255,.15);border-radius:10px}
    .grid{display:grid;gap:12px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:14px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:right}
    th:first-child,td:first-child{text-align:left}
    .muted{color:var(--muted)}
    .home-icon{position:fixed;top:14px;left:16px;color:var(--fg);text-decoration:none}
  </style>
</head>
<body class="dark">
  <a href="../index.html" class="home-icon" title="Back to Home">⌂</a>

  <main class="wrap">
    <h1 id="title">Loading…</h1>
    <div class="tabs">
      <a id="tab-statements" href="#">Statements</a>
      <a id="tab-ratios" href="#">Ratios</a>
      <a id="tab-overview" href="./index.html">Overview</a>
    </div>

    <p id="warn" class="muted"></p>

    <div class="grid">
      <section class="card">
        <h3>Income Statement (Annual)</h3>
        <div id="inc"></div>
      </section>
      <section class="card">
        <h3>Balance Sheet (Annual)</h3>
        <div id="bal"></div>
      </section>
      <section class="card">
        <h3>Cash Flow (Annual)</h3>
        <div id="cf"></div>
      </section>
    </div>
  </main>

  <script src="./api.js?v=3"></script>
  <script>
    // --- read ticker from URL ---
    const params = new URLSearchParams(location.search);
    const T = (params.get("t") || "").toUpperCase().trim();

    const $title = document.getElementById("title");
    const $warn = document.getElementById("warn");
    const $inc = document.getElementById("inc");
    const $bal = document.getElementById("bal");
    const $cf = document.getElementById("cf");

    // fix tab links with ticker
    document.getElementById("tab-statements").href = `./statements.html?t=${encodeURIComponent(T)}`;
    document.getElementById("tab-ratios").href = `./ratios.html?t=${encodeURIComponent(T)}`;

    async function render(){
      if (!T){ $title.textContent = "Missing ticker"; return; }
      if (window.__FMP?.needKey()){
        $warn.textContent = "Add your API key on the Overview page to load data.";
        $title.textContent = T;
        return;
      }
      try {
        const [p, inc, bal, cf] = await Promise.all([
          __FMP.profile(T), __FMP.income(T,4), __FMP.balance(T,4), __FMP.cashflow(T,4)
        ]);
        $title.textContent = `${T} — ${p?.companyName ?? ""}`;
        $warn.textContent = "";

        // build columns by year
        const years = (inc||[]).map(r=>__FMP.y(r.date));
        function table(cols, rows){
          const thead = `<thead><tr><th>Metric</th>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead>`;
          const body = rows.map(([label, vals]) =>
            `<tr><td>${label}</td>${vals.map(v=>`<td>${v}</td>`).join("")}</tr>`).join("");
          return `<table>${thead}<tbody>${body}</tbody></table>`;
        }

        // income rows
        const incRows = [
          ["Revenue",        inc.map(r => __FMP.com(r.revenue))],
          ["Gross Profit",   inc.map(r => __FMP.com(r.grossProfit))],
          ["Operating Inc.", inc.map(r => __FMP.com(r.operatingIncome))],
          ["Net Income",     inc.map(r => __FMP.com(r.netIncome))],
          ["EPS (basic)",    inc.map(r => r.eps ? r.eps.toFixed(2) : "—")],
          ["Net Margin",     inc.map(r => (r.revenue && r.netIncome) ? ((r.netIncome/r.revenue)*100).toFixed(1)+'%' : '—')],
        ];
        $inc.innerHTML = table(years, incRows);

        // balance rows
        const balRows = [
          ["Cash & Equivalents", bal.map(r => __FMP.com(r.cashAndCashEquivalents))],
          ["Total Assets",       bal.map(r => __FMP.com(r.totalAssets))],
          ["Total Liabilities",  bal.map(r => __FMP.com(r.totalLiabilities))],
          ["Total Debt",         bal.map(r => __FMP.com(r.totalDebt))],
          ["Shareholders' Equity", bal.map(r => __FMP.com(r.totalStockholdersEquity))],
          ["Current Ratio",      bal.map((r,i) => {
            const cr = (r.totalCurrentAssets && r.totalCurrentLiabilities)
              ? (r.totalCurrentAssets / r.totalCurrentLiabilities) : null;
            return cr ? cr.toFixed(2) : "—";
          })],
        ];
        $bal.innerHTML = table(years, balRows);

        // cash flow rows
        const cfRows = [
          ["Operating CF", cf.map(r => __FMP.com(r.netCashProvidedByOperatingActivities))],
          ["Investing CF", cf.map(r => __FMP.com(r.netCashUsedForInvestingActivites || r.netCashUsedForInvestingActivities))],
          ["Financing CF", cf.map(r => __FMP.com(r.netCashUsedProvidedByFinancingActivities))],
          ["Free CF",      cf.map(r => __FMP.com(
              (typeof r.freeCashFlow === "number") ? r.freeCashFlow
              : ((r.netCashProvidedByOperatingActivities ?? 0) - (r.capitalExpenditure ?? 0))
          ))],
          ["CapEx",        cf.map(r => __FMP.com(r.capitalExpenditure))],
        ];
        $cf.innerHTML = table(years, cfRows);

      } catch (e){
        console.error(e);
        $title.textContent = T;
        $warn.textContent = `Could not load ${T}. Check your API key or ticker.`;
      }
    }
    render();
  </script>
</body>
</html>
