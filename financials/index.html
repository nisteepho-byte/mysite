<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Financials — Overview</title>
  <link rel="stylesheet" href="../style.css"/>
  <style>
    .wrap{max-width:1000px;margin:90px auto 40px;padding:0 20px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .search input{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:transparent;color:var(--fg)}
    body:not(.dark) .search input{border-color:#e2e6ef;color:#111}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:14px}
    .card{display:block;background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:14px;color:inherit}
    .muted{color:var(--muted)}
    .home-icon{position:fixed;top:14px;left:16px;color:var(--fg);text-decoration:none}
  </style>
</head>
<body class="dark">
  <a href="../index.html" class="home-icon" title="Back to Home">⌂</a>

  <main class="wrap">
    <h1>Financials</h1>
    <p class="muted">Type any ticker (e.g., AAPL, MSFT, NVDA). The API key is stored locally in your browser.</p>

    <div class="row search" style="margin:10px 0 6px">
      <input id="ticker" placeholder="Ticker (e.g., AAPL)" />
      <button id="open" class="btn">Open</button>
    </div>

    <p id="warn" class="muted" style="margin:6px 0 0"></p>
    <div id="keybox" class="row" style="display:none;margin-top:8px">
      <input id="keyin" placeholder="Paste your FMP API key"/>
      <button id="savekey" class="btn">Save Key</button>
    </div>

    <h2 style="margin-top:18px">Examples</h2>
    <div id="examples" class="grid"></div>
  </main>

  <script src="./api.js?v=3"></script>
  <script>
    const $t = document.getElementById('ticker');
    const $open = document.getElementById('open');
    const $warn = document.getElementById('warn');
    const $keybox = document.getElementById('keybox');
    const $keyin = document.getElementById('keyin');
    const $savekey = document.getElementById('savekey');
    const $examples = document.getElementById('examples');

    function showKeyUI(){
      if (window.__FMP?.needKey()) {
        $warn.textContent = "⚠️ Add your FMP API key to enable live data.";
        $keybox.style.display = 'flex';
      } else {
        $warn.textContent = "";
        $keybox.style.display = 'none';
      }
    }
    showKeyUI();

    $savekey.addEventListener('click', ()=>{
      if (window.__FMP?.setFmpKey($keyin.value.trim())) {
        $keyin.value = "";
        showKeyUI();
        location.reload(); // pull fresh with key
      }
    });

    function go() {
      const tk = ($t.value||"").trim();
      if (!tk) return;
      location.href = `./statements.html?t=${encodeURIComponent(tk)}`;
    }
    $open.addEventListener('click', go);
    $t.addEventListener('keydown', e => { if (e.key === 'Enter') go(); });

    async function loadExamples(){
      if (window.__FMP?.needKey()) return;
      const picks = ["AAPL","MSFT","NVDA","TSLA","AMZN","META"];
      $examples.innerHTML = "";
      for (const tk of picks) {
        try {
          const [p, q, is] = await Promise.all([
            __FMP.profile(tk), __FMP.quote(tk), __FMP.income(tk,1)
          ]);
          const rev = is?.[0]?.revenue ?? null;
          const net = is?.[0]?.netIncome ?? null;
          const margin = (rev && net) ? ((net/rev)*100).toFixed(1)+"%" : "—";
          $examples.insertAdjacentHTML("beforeend", `
            <a class="card" href="./statements.html?t=${encodeURIComponent(tk)}">
              <h3>${tk} — ${p?.companyName ?? ""}</h3>
              <p class="muted">${p?.sector ?? ""}${p?.industry ? " • "+p.industry : ""}</p>
              <div class="row" style="margin-top:8px">
                <span class="pill">Price: <strong>${q?.price ?? "—"}</strong></span>
                <span class="pill">MktCap: <strong>${q?.marketCap ? __FMP.b(q.marketCap) : "—"}</strong></span>
                <span class="pill">Revenue: <strong>${rev ? __FMP.b(rev) : "—"}</strong></span>
                <span class="pill">Net margin: <strong>${margin}</strong></span>
              </div>
            </a>
          `);
        } catch(e){/* ignore that card */}
      }
    }
    loadExamples();
  </script>
</body>
</html>
