<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Financials — Live</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Page-scoped polish (uses your global tokens) */
    .wrap{max-width:1100px;margin:90px auto 40px;padding:0 20px}
    .home-icon{
      position:fixed; top:14px; left:16px; text-decoration:none; font-size:22px;
      padding:6px 10px; border-radius:12px; z-index:9999; color:var(--fg);
      border:1px solid rgba(255,255,255,.14); background:var(--card);
    }
    body:not(.dark) .home-icon{ border-color:#e6e7ef; color:#111; background:#fff; }
    .home-icon:hover{ opacity:.9 }
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    input[type="text"],button{
      padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18);
      background:transparent; color:var(--fg)
    }
    body:not(.dark) input[type="text"], body:not(.dark) button{ border-color:#e2e6ef; color:#111 }
    .btn{ cursor:pointer; border:1px solid var(--accent); background:var(--accent); color:#fff }
    .muted{ color:var(--muted) }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 16px }
    .tab{ padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15); text-decoration:none; color:inherit }
    .tab.active{ border-color:var(--accent) }
    .hidden{ display:none !important }
    .cards{ display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px }
    .card{ background:var(--card); border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:14px }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15) }
    .sep{ opacity:.2; border:none; border-top:1px solid rgba(255,255,255,.12); margin:14px 0 }
    .status{ font-size:14px; }
    .ok{ color:#38d39f } .bad{ color:#ff6b6b }
    table{ width:100%; border-collapse:collapse }
    th,td{ padding:8px; border-bottom:1px solid rgba(255,255,255,.08); text-align:right }
    th:first-child, td:first-child{ text-align:left }
  </style>
</head>
<body class="dark">
  <a class="home-icon" href="./index.html" title="Back to Home">⌂</a>

  <main class="wrap">
    <h1>Financials (Live)</h1>
    <p class="muted">Enter any US ticker. Data fetched via your backend proxy (Cloudflare Worker) so it works for *all* tickers.</p>

    <div class="row" style="margin:8px 0">
      <input id="ticker" type="text" placeholder="Ticker (e.g., AAPL)"/>
      <button id="open" class="btn">Open</button>
      <span id="status" class="status muted">Ready.</span>
    </div>
    <hr class="sep"/>

    <nav class="tabs">
      <a href="#" data-tab="overview" class="tab active">Overview</a>
      <a href="#" data-tab="statements" class="tab">Statements</a>
      <a href="#" data-tab="ratios" class="tab">Ratios</a>
    </nav>

    <!-- Overview -->
    <section id="panel-overview">
      <div id="ov"></div>
      <h3 style="margin-top:14px">Recent Searches</h3>
      <div class="cards" id="recent"></div>
    </section>

    <!-- Statements -->
    <section id="panel-statements" class="hidden">
      <div class="card"><h3>Income Statement (Annual)</h3><div id="inc"></div></div>
      <div class="card" style="margin-top:12px"><h3>Balance Sheet (Annual)</h3><div id="bal"></div></div>
      <div class="card" style="margin-top:12px"><h3>Cash Flow (Annual)</h3><div id="cf"></div></div>
    </section>

    <!-- Ratios -->
    <section id="panel-ratios" class="hidden">
      <div class="card"><h3>Key Ratios</h3><div id="rt"></div></div>
    </section>
  </main>

  <script>
  // ===== UI helpers =====
  const $ = s=>document.querySelector(s);
  const $$ = s=>[...document.querySelectorAll(s)];
  const els = {
    ticker: $('#ticker'), open: $('#open'), status: $('#status'),
    tabs: $$('.tab'),
    pOverview: $('#panel-overview'), pStatements: $('#panel-statements'), pRatios: $('#panel-ratios'),
    ov: $('#ov'), recent: $('#recent'),
    inc: $('#inc'), bal: $('#bal'), cf: $('#cf'), rt: $('#rt')
  };
  const fmtB = n => (typeof n==="number" ? (Math.abs(n)>=1e9 ? (n/1e9).toFixed(1)+'B' : n.toLocaleString()) : '—');
  const fmtC = n => (typeof n==="number" ? n.toLocaleString() : '—');

  // Tabs
  els.tabs.forEach(a=>{
    a.addEventListener('click', e=>{
      e.preventDefault();
      els.tabs.forEach(x=>x.classList.remove('active')); a.classList.add('active');
      const t=a.dataset.tab;
      els.pOverview.classList.toggle('hidden', t!=='overview');
      els.pStatements.classList.toggle('hidden', t!=='statements');
      els.pRatios.classList.toggle('hidden', t!=='ratios');
    });
  });

  // Recent search pills
  function pushRecent(tk, name){
    const key='fin_recent';
    const arr = JSON.parse(localStorage.getItem(key) || '[]').filter(x=>x.tk!==tk);
    arr.unshift({tk,name}); if (arr.length>8) arr.length=8;
    localStorage.setItem(key, JSON.stringify(arr));
    renderRecent();
  }
  function renderRecent(){
    const arr = JSON.parse(localStorage.getItem('fin_recent') || '[]');
    els.recent.innerHTML = '';
    arr.forEach(({tk,name})=>{
      const a = document.createElement('a');
      a.href='#'; a.className='card'; a.innerHTML = `<h3>${tk}</h3><p class="muted">${name||''}</p>`;
      a.onclick = (e)=>{ e.preventDefault(); els.ticker.value=tk; openTicker(); };
      els.recent.appendChild(a);
    });
  }
  renderRecent();

  // Renderers
  function table(cols, rows){
    const head = `<thead><tr><th>Metric</th>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>`;
    const body = rows.map(([name,vals])=>`<tr><td>${name}</td>${vals.map(v=>`<td>${v}</td>`).join('')}</tr>`).join('');
    return `<table>${head}<tbody>${body}</tbody></table>`;
  }

  async function openTicker(){
    const tk = (els.ticker.value||'').trim().toUpperCase();
    if (!tk){ els.status.innerHTML = "<span class='bad'>Enter a ticker.</span>"; return; }
    els.status.textContent = "Loading…";

    try{
      // Hit your Worker proxy
      const res = await fetch(`/api/financials?ticker=${encodeURIComponent(tk)}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (!data || !data.overview) throw new Error(`No data for ${tk}`);

      // Overview card
      const o = data.overview;
      els.ov.innerHTML = `
        <div class="card">
          <h2>${o.ticker} — ${o.companyName||''}</h2>
          <p class="muted">${o.sector||''}${o.industry? ' • '+o.industry : ''}</p>
          <div class="row" style="margin-top:8px">
            <span class="pill">Price: <strong>${o.price??'—'}</strong></span>
            <span class="pill">MktCap: <strong>${o.marketCap ? fmtB(o.marketCap) : '—'}</strong></span>
            <span class="pill">Revenue (TTM/Latest): <strong>${o.revenue ? fmtB(o.revenue) : '—'}</strong></span>
            <span class="pill">Net Margin: <strong>${o.netMargin ?? '—'}</strong></span>
          </div>
        </div>
      `;
      pushRecent(o.ticker, o.companyName||'');

      // Years newest→oldest
      const years = (data.years||[]).map(String);

      // Income
      const inc = data.income||{};
      els.inc.innerHTML = table(years, [
        ["Revenue", years.map(y=>fmtC(inc[y]?.revenue))],
        ["Gross Profit", years.map(y=>fmtC(inc[y]?.grossProfit))],
        ["Operating Income", years.map(y=>fmtC(inc[y]?.operatingIncome))],
        ["Net Income", years.map(y=>fmtC(inc[y]?.netIncome))],
        ["EPS", years.map(y=>inc[y]?.eps!=null ? Number(inc[y].eps).toFixed(2) : '—')],
        ["Net Margin", years.map(y=>{
          const r=inc[y]?.revenue, n=inc[y]?.netIncome;
          return (r&&n)? ((n/r)*100).toFixed(1)+'%' : '—';
        })]
      ]);

      // Balance
      const bal = data.balance||{};
      els.bal.innerHTML = table(years, [
        ["Cash & Equivalents", years.map(y=>fmtC(bal[y]?.cash))],
        ["Total Assets", years.map(y=>fmtC(bal[y]?.assets))],
        ["Total Liabilities", years.map(y=>fmtC(bal[y]?.liabilities))],
        ["Total Debt", years.map(y=>fmtC(bal[y]?.debt))],
        ["Shareholders' Equity", years.map(y=>fmtC(bal[y]?.equity))],
        ["Current Ratio", years.map(y=>{
          const ca=bal[y]?.currAssets, cl=bal[y]?.currLiab, cr=(ca&&cl)? ca/cl : null;
          return cr ? cr.toFixed(2) : '—';
        })]
      ]);

      // Cash Flow
      const cf = data.cashflow||{};
      els.cf.innerHTML = table(years, [
        ["Operating CF", years.map(y=>fmtC(cf[y]?.opCF))],
        ["Investing CF", years.map(y=>fmtC(cf[y]?.invCF))],
        ["Financing CF", years.map(y=>fmtC(cf[y]?.finCF))],
        ["CapEx", years.map(y=>fmtC(cf[y]?.capex))],
        ["Free CF", years.map(y=>{
          const v=cf[y]?.freeCF, op=cf[y]?.opCF??0, cap=cf[y]?.capex??0;
          return fmtC(v!=null ? v : (op-cap));
        })]
      ]);

      // Ratios
      const r = data.ratios||{};
      els.rt.innerHTML = table(years, [
        ["Operating Margin", years.map(y=>{
          const rv=inc[y]?.revenue, op=inc[y]?.operatingIncome;
          return (rv&&op)? ((op/rv)*100).toFixed(1)+'%' : '—';
        })],
        ["Net Margin", years.map(y=>{
          const rv=inc[y]?.revenue, n=inc[y]?.netIncome;
          return (rv&&n)? ((n/rv)*100).toFixed(1)+'%' : '—';
        })],
        ["ROE", years.map(y=> r[y]?.roe!=null ? (r[y].roe*100).toFixed(1)+'%' : '—')],
        ["ROA", years.map(y=> r[y]?.roa!=null ? (r[y].roa*100).toFixed(1)+'%' : '—')],
        ["Debt / Equity", years.map(y=> r[y]?.debtToEquity!=null ? r[y].debtToEquity.toFixed(2) : '—')],
        ["Asset Turnover", years.map(y=> r[y]?.assetTurnover!=null ? r[y].assetTurnover.toFixed(2) : '—')],
        ["P/E", years.map(y=> r[y]?.pe!=null ? r[y].pe.toFixed(1) : '—')],
        ["P/S", years.map(y=> r[y]?.ps!=null ? r[y].ps.toFixed(1) : '—')]
      ]);

      // Switch to statements after first load
      els.tabs.forEach(x=>x.classList.remove('active'));
      document.querySelector('[data-tab="statements"]').classList.add('active');
      els.pOverview.classList.add('hidden');
      els.pStatements.classList.remove('hidden');
      els.pRatios.classList.add('hidden');

      els.status.innerHTML = `<span class="ok">Loaded ${o.ticker} ✓</span>`;
    }catch(err){
      console.error(err);
      els.status.innerHTML = `<span class="bad">Could not load. Check your backend / ticker.</span>`;
    }
  }

  els.open.addEventListener('click', openTicker);
  els.ticker.addEventListener('keydown', e=>{ if (e.key==='Enter') openTicker(); });
  </script>
</body>
</html>
