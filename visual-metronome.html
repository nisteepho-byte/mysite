<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Visual Metronome — Nick Isteepho</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Page-scoped styles (uses your theme vars) */
    .vm-wrap{max-width:800px;margin:90px auto 48px;padding:0 20px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .label{font-size:12px;color:var(--muted)}
    .input{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:transparent;color:var(--fg);width:90px}
    body:not(.dark) .input{border-color:#e6e7ef;color:#111}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--accent);background:transparent;color:var(--fg);cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .mini{font-size:12px;color:var(--muted)}

    /* Visual stage */
    .stage{display:grid;place-items:center;gap:12px;padding:16px}
    .circle{width:260px;max-width:100%;aspect-ratio:1;border-radius:50%;
      border:10px solid rgba(255,255,255,.08);display:grid;place-items:center;position:relative}
    .pulse{width:70%;height:70%;border-radius:50%;background:var(--accent);
      opacity:.12;transform:scale(.9);transition:transform .06s ease, opacity .06s ease}
    .bar{width:100%;height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .bar>span{display:block;height:100%;width:0%;background:var(--accent);transition:width .06s linear}
    .beats{display:grid;grid-auto-flow:column;grid-auto-columns:1fr;gap:6px;width:100%}
    .pill{padding:8px 0;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,.16);color:var(--muted)}
    .pill.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .home-icon:hover{background:rgba(255,255,255,.08);border-radius:50%}
  </style>
</head>
<body class="dark">
  <header class="wrap culinary-header">
    <a href="index.html" class="home-icon" title="Back to Home">⌂</a>
    <div class="header-text">
      <h1>Visual Metronome</h1>
      <p class="sub">Simple and clean: Start/Stop, BPM, Tap Tempo, visual pulse, and click.</p>
    </div>
  </header>

  <main class="vm-wrap">
    <section class="card">
      <div class="row">
        <div>
          <div class="label">Tempo (BPM)</div>
          <input id="bpm" class="input" type="number" min="20" max="300" value="100"/>
        </div>
        <button id="start" class="btn primary">Start</button>
        <button id="stop" class="btn">Stop</button>
        <button id="tap" class="btn">Tap</button>
        <label class="row" style="gap:8px;margin-left:auto">
          <input id="mute" type="checkbox"/> <span class="label">Mute</span>
        </label>
      </div>
      <p class="mini">Shortcuts: Space = Start/Stop · T = Tap · ↑/↓ = BPM ±1 · Shift+↑/↓ = BPM ±5</p>
    </section>

    <section class="card stage">
      <div class="circle">
        <div id="pulse" class="pulse"></div>
      </div>
      <div class="bar"><span id="prog"></span></div>
      <div id="beats" class="beats"></div>
      <div class="mini" id="readout">—</div>
    </section>
  </main>

  <script>
  // Elements
  const $ = s => document.querySelector(s);
  const el = {
    bpm: $('#bpm'), start: $('#start'), stop: $('#stop'), tap: $('#tap'), mute: $('#mute'),
    pulse: $('#pulse'), prog: $('#prog'), beats: $('#beats'), readout: $('#readout')
  };

  // Build simple 4/4 pills
  let beatsPerBar = 4;
  function renderBeats(){
    el.beats.innerHTML = '';
    for(let i=0;i<beatsPerBar;i++){
      const d = document.createElement('div');
      d.className = 'pill';
      d.textContent = i+1;
      el.beats.appendChild(d);
    }
  }
  renderBeats();

  // Audio
  let ctx, gain;
  function ensureAudio(){
    if (!ctx){
      ctx = new (window.AudioContext||window.webkitAudioContext)();
      gain = ctx.createGain(); gain.gain.value = 0.85; gain.connect(ctx.destination);
    }
  }
  function click(fHz, t){
    if (el.mute.checked) return;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'square'; o.frequency.setValueAtTime(fHz, t);
    g.gain.setValueAtTime(0.6, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + 0.02);
    o.connect(g); g.connect(gain);
    o.start(t); o.stop(t + 0.04);
  }

  // Scheduler (lightweight)
  let running = false, nextTime = 0, step = 0, raf = 0;
  function settings(){
    const bpm = Math.max(20, Math.min(300, parseInt(el.bpm.value||100,10)));
    const beatDur = 60/bpm;       // quarter note
    return { bpm, beatDur };
  }

  function schedule(){
    const { beatDur, bpm } = settings();
    const lookahead = 0.12;
    const stepsPerBar = beatsPerBar; // quarter notes
    while (nextTime < ctx.currentTime + lookahead){
      const beatIndex = step % stepsPerBar;
      // sound
      click( beatIndex===0 ? 1600 : 1100, nextTime );
      // visuals at play time
      const dt = Math.max(0, nextTime - ctx.currentTime);
      setTimeout(()=>{
        // pulse
        el.pulse.style.opacity = beatIndex===0 ? .45 : .25;
        el.pulse.style.transform = 'scale(1.0)';
        setTimeout(()=>{ el.pulse.style.opacity=.12; el.pulse.style.transform='scale(.9)'; }, 70);

        // pills
        [...el.beats.children].forEach((p,i)=>p.classList.toggle('active', i===beatIndex));

        // progress
        const frac = (beatIndex/stepsPerBar)*100;
        el.prog.style.width = frac.toFixed(1)+'%';

        // label
        el.readout.textContent = `Beat ${beatIndex+1}/${stepsPerBar} • ${bpm} BPM`;
      }, dt*1000);

      // advance
      step++;
      nextTime += beatDur;
    }
  }

  function tick(){
    if (!running) return;
    schedule();
    raf = requestAnimationFrame(tick);
  }

  function start(){
    ensureAudio();
    const { beatDur } = settings();
    running = true;
    step = 0;
    nextTime = ctx.currentTime + 0.06;
    cancelAnimationFrame(raf);
    tick();
  }
  function stop(){
    running = false;
    cancelAnimationFrame(raf);
    el.prog.style.width = '0%';
    [...el.beats.children].forEach(p=>p.classList.remove('active'));
    el.readout.textContent = '—';
  }

  // Tap tempo (average last 5)
  let taps = [];
  function tap(){
    const now = performance.now();
    taps.push(now); if (taps.length>6) taps.shift();
    if (taps.length>=2){
      const diffs = taps.slice(1).map((t,i)=>t - taps[i]);
      const avg = diffs.reduce((a,b)=>a+b,0)/diffs.length;
      const bpm = Math.max(20, Math.min(300, Math.round(60000/avg)));
      el.bpm.value = bpm;
    }
  }

  // Events
  el.start.addEventListener('click', start);
  el.stop.addEventListener('click', stop);
  el.tap.addEventListener('click', tap);
  el.bpm.addEventListener('change', ()=>{ if (running){ stop(); start(); }});

  // Keys
  document.addEventListener('keydown', e=>{
    if (e.code==='Space'){ e.preventDefault(); running ? stop() : start(); }
    if (e.key.toLowerCase()==='t'){ tap(); }
    if (e.key==='ArrowUp'){ el.bpm.value = Math.min(300, parseInt(el.bpm.value,10)+(e.shiftKey?5:1)); if (running){ stop(); start(); } }
    if (e.key==='ArrowDown'){ el.bpm.value = Math.max(20, parseInt(el.bpm.value,10)-(e.shiftKey?5:1)); if (running){ stop(); start(); } }
  });
  </script>
</body>
</html>
